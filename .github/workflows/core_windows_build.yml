name: Windows Build (MSVC)

on:
  push:
    branches: [ master , devel ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false

    steps:
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      
      - name: Cache OpenSSL
        id: cache-openssl
        uses: actions/cache@v4
        with:
          path: |
            C:\Program Files\OpenSSL
            C:\Program Files\OpenSSL-Win64
          key: ${{ runner.os }}-openssl-full

      
      - name: Install full OpenSSL (developer)
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          Write-Host "Installing latest full OpenSSL for development..."
          choco upgrade openssl -y --no-progress
          $ver = & openssl version
          Write-Host "Installed OpenSSL version: $ver"

      
      - name: Setup Windows 10 SDK
        uses: GuillaumeFalourd/setup-windows10-sdk-action@v2
        with:
          sdk-version: 22621

      
      - name: Configure OpenSSL environment
        shell: bash
        run: |
          if [ -d "C:/Program Files/OpenSSL/lib/VC" ]; then
            echo "OPENSSL_ROOT_DIR=C:/Program Files/OpenSSL" >> $GITHUB_ENV
            echo "OPENSSL_INCLUDE_DIR=C:/Program Files/OpenSSL/include" >> $GITHUB_ENV
            echo "OPENSSL_CRYPTO_LIBRARY=C:/Program Files/OpenSSL/lib/VC/libcrypto64MT.lib" >> $GITHUB_ENV
            echo "OPENSSL_SSL_LIBRARY=C:/Program Files/OpenSSL/lib/VC/libssl64MT.lib" >> $GITHUB_ENV
          elif [ -d "C:/Program Files/OpenSSL-Win64/lib/VC" ]; then
            echo "OPENSSL_ROOT_DIR=C:/Program Files/OpenSSL-Win64" >> $GITHUB_ENV
            echo "OPENSSL_INCLUDE_DIR=C:/Program Files/OpenSSL-Win64/include" >> $GITHUB_ENV
            echo "OPENSSL_CRYPTO_LIBRARY=C:/Program Files/OpenSSL-Win64/lib/VC/libcrypto64MT.lib" >> $GITHUB_ENV
            echo "OPENSSL_SSL_LIBRARY=C:/Program Files/OpenSSL-Win64/lib/VC/libssl64MT.lib" >> $GITHUB_ENV
          fi

      
      - name: Cache CMake build
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-cmake-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-cmake-

      
      - name: Configure CMake project
        shell: bash
        run: |
          mkdir -p build && cd build
          cmake .. \
            -G "Visual Studio 17 2022" \
            -A x64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DOPENSSL_USE_STATIC_LIBS=TRUE \
            -DBUILD_TOOLS=1 \
            -DBUILD_MANGOSD=1 \
            -DBUILD_REALMD=1 \
            -DSOAP=1 \
            -DSCRIPT_LIB_ELUNA=1 \
            -DSCRIPT_LIB_SD3=1 \
            -DPLAYERBOTS=1 \
            -DUSE_STORMLIB=1 \
            -DPCH=0

      
      - name: Build project
        shell: bash
        run: |
          cd build
          cmake --build . --config Release --parallel
